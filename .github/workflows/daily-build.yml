name: Daily RPi4 Build & Test

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 2ì‹œ (UTC) ì‹¤í–‰ = í•œêµ­ì‹œê°„ 11ì‹œ
    - cron: '0 2 * * *'
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
    inputs:
      force_rebuild:
        description: 'ê°•ì œ ë¦¬ë¹Œë“œ (ìºì‹œ ë¬´ì‹œ)'
        required: false
        default: 'false'
        type: boolean

env:
  # ë¹Œë“œ ì„¤ì •
  IMAGE_NAME: rpi4-boot-builder
  CONTAINER_NAME: rpi4-builder-ci
  ARTIFACT_NAME: rpi4-complete-image
  
jobs:
  build:
    name: RPi4 ì»¤ë„ ë¹Œë“œ
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2ì‹œê°„ ì œí•œ
    
    steps:
    - name: ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ë””ìŠ¤í¬ ê³µê°„ í™•ë³´
      run: |
        # GitHub Actions ëŸ¬ë„ˆ ê³µê°„ ìµœì í™”
        sudo apt-get clean
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/share/boost
        df -h
        
    - name: Docker Buildx ì„¤ì •
      uses: docker/setup-buildx-action@v3
      
    - name: ë¹Œë“œ ìºì‹œ ë³µì›
      if: ${{ github.event.inputs.force_rebuild != 'true' }}
      uses: actions/cache@v4
      with:
        path: |
          /tmp/.buildx-cache
          ./cache
        key: rpi4-build-${{ runner.os }}-${{ hashFiles('Dockerfile') }}
        restore-keys: |
          rpi4-build-${{ runner.os }}-
          
    - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ
      run: |
        docker build -t ${{ env.IMAGE_NAME }}:latest .
        docker images
        
    - name: RPi4 ë¹Œë“œ ì‹¤í–‰
      run: |
        echo "ğŸš€ RPi4 ë¹Œë“œ ì‹œì‘ - $(date)"
        
        # CI ì „ìš© ë¹Œë“œ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        python3 ci-build.py
        
        echo "âœ… ë¹Œë“œ ì™„ë£Œ - $(date)"
        
    - name: ë¹Œë“œ ê²°ê³¼ ê²€ì¦
      run: |
        # ì´ë¯¸ì§€ ë¬´ê²°ì„± ê²€ì‚¬
        echo "ğŸ” ì´ë¯¸ì§€ ê²€ì¦ ì¤‘..."
        
        # íŒŒí‹°ì…˜ êµ¬ì¡° í™•ì¸
        sudo fdisk -l rpi4-complete.img
        
        # íŒŒì¼ í¬ê¸° í™•ì¸ (100MB-200MB ë²”ìœ„)
        SIZE=$(stat -c%s rpi4-complete.img)
        MIN_SIZE=$((100 * 1024 * 1024))  # 100MB
        MAX_SIZE=$((200 * 1024 * 1024))  # 200MB
        
        if [ $SIZE -lt $MIN_SIZE ] || [ $SIZE -gt $MAX_SIZE ]; then
          echo "âŒ ì´ë¯¸ì§€ í¬ê¸° ì´ìƒ: ${SIZE} bytes"
          exit 1
        fi
        
        echo "âœ… ì´ë¯¸ì§€ ê²€ì¦ í†µê³¼: ${SIZE} bytes"
        
    - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.ARTIFACT_NAME }}-${{ github.run_number }}
        path: |
          rpi4-complete.img
          build.log
          build_progress.log
        retention-days: 30
        
    - name: ë¹Œë“œ í†µê³„ ìƒì„±
      run: |
        echo "ğŸ“Š ë¹Œë“œ í†µê³„" > build-stats.md
        echo "- ë¹Œë“œ ë²ˆí˜¸: ${{ github.run_number }}" >> build-stats.md
        echo "- ë¹Œë“œ ì‹œê°„: $(date)" >> build-stats.md
        echo "- ì»¤ë°‹: ${{ github.sha }}" >> build-stats.md
        echo "- ì´ë¯¸ì§€ í¬ê¸°: $(ls -lh rpi4-complete.img | awk '{print $5}')" >> build-stats.md
        cat build-stats.md
        
  notify:
    name: ë¹Œë“œ ê²°ê³¼ ì•Œë¦¼
    needs: build
    runs-on: ubuntu-latest
    if: always()  # ì„±ê³µ/ì‹¤íŒ¨ ê´€ê³„ì—†ì´ ì‹¤í–‰
    
    steps:
    - name: í…”ë ˆê·¸ë¨ ì•Œë¦¼
      if: ${{ vars.TELEGRAM_BOT_TOKEN && vars.TELEGRAM_CHAT_ID }}
      run: |
        if [ "${{ needs.build.result }}" == "success" ]; then
          MESSAGE="âœ… RPi4 ë¹Œë“œ ì„±ê³µ
        ğŸ“… $(date '+%Y-%m-%d %H:%M')
        ğŸ”— ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        else
          MESSAGE="âŒ RPi4 ë¹Œë“œ ì‹¤íŒ¨
        ğŸ“… $(date '+%Y-%m-%d %H:%M')
        ğŸ”— ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        fi
        
        curl -s -X POST "https://api.telegram.org/bot${{ vars.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d chat_id="${{ vars.TELEGRAM_CHAT_ID }}" \
          -d text="$MESSAGE"
          
    - name: Discord ì•Œë¦¼ (ì„ íƒì‚¬í•­)
      if: ${{ vars.DISCORD_WEBHOOK_URL }}
      run: |
        STATUS_EMOJI="${{ needs.build.result == 'success' && 'âœ…' || 'âŒ' }}"
        curl -H "Content-Type: application/json" \
          -X POST \
          -d "{\"content\":\"$STATUS_EMOJI RPi4 ë¹Œë“œ ${{ needs.build.result }} - $(date)\"}" \
          "${{ vars.DISCORD_WEBHOOK_URL }}"
          
  cleanup:
    name: ì •ë¦¬ ì‘ì—…
    needs: [build, notify]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ì˜¤ë˜ëœ ì•„í‹°íŒ©íŠ¸ ì •ë¦¬
      run: |
        echo "ğŸ—‘ï¸ 30ì¼ ì´ìƒ ëœ ì•„í‹°íŒ©íŠ¸ëŠ” ìë™ ì‚­ì œë©ë‹ˆë‹¤"
        # GitHubì—ì„œ ìë™ ì²˜ë¦¬ë¨ (retention-days: 30)